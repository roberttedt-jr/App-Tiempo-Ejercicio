<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atmos | Tu Clima</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        glass: 'rgba(255, 255, 255, 0.15)',
                        glassDark: 'rgba(0, 0, 0, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Transiciones de fondo */
        body {
            transition: background-image 1s ease-in-out, background-color 1s ease-in-out;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: white;
            min-height: 100vh;
            height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Fondos según el clima */
        .bg-sunny { background: linear-gradient(-45deg, #2980B9, #6DD5FA, #FFFFFF); } 
        .bg-cloudy { background: linear-gradient(-45deg, #757F9A, #D7DDE8); } 
        .bg-rainy { background: linear-gradient(-45deg, #373B44, #4286f4); } 
        .bg-night { background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e); } 
        .bg-storm { background: linear-gradient(-45deg, #232526, #414345); } 

        .custom-scroll::-webkit-scrollbar { height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }

        .weather-effect { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; overflow: hidden; }
        
        .rain { position: absolute; width: 2px; height: 20px; background: rgba(255,255,255,0.4); top: -20px; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(105vh); } }

        .cloud { position: absolute; opacity: 0.3; animation: floatCloud linear infinite; }
        @keyframes floatCloud { from { transform: translateX(-100%); } to { transform: translateX(100vw); } }
        
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle infinite alternate; }
        @keyframes twinkle { from { opacity: 0.3; } to { opacity: 1; } }

        .sun-glow {
            position: absolute; top: -100px; right: -100px; width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(255,215,0,0.4) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%; opacity: 0.8; animation: pulseSun 6s infinite ease-in-out;
        }
        @keyframes pulseSun { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* Logo animado */
        .logo-dot { animation: pulse 2s infinite; }

        #detailModal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-open { opacity: 1; pointer-events: auto; transform: scale(1); }
        .modal-closed { opacity: 0; pointer-events: none; transform: scale(0.95); }
    </style>
</head>
<body class="bg-sunny p-0 md:p-4 relative">

    <!-- Capa de Efectos -->
    <div id="weatherEffects" class="weather-effect fixed inset-0"></div>

    <!-- Contenedor Principal -->
    <div class="w-full h-screen md:h-[850px] md:w-[400px] bg-glass backdrop-blur-2xl md:rounded-[3rem] shadow-2xl relative overflow-hidden flex flex-col border border-white/20 z-10 text-center mx-auto flex-none">
        
        <!-- Header con Logo ATMOS -->
        <div class="pt-8 px-6 flex justify-between items-center z-20 w-full mb-2">
            <button onclick="toggleFavorites()" class="text-white/80 hover:text-white transition p-2"><i class="fas fa-bars text-xl"></i></button>
            
            <!-- LOGO -->
            <div class="flex items-center justify-center gap-1 tracking-widest flex-1 select-none">
                <i class="fas fa-wind text-xl opacity-80"></i>
                <span class="font-bold text-2xl tracking-[0.2em] uppercase">Atmos</span>
                <div class="w-1.5 h-1.5 bg-white rounded-full logo-dot mt-2"></div>
            </div>
            
            <button onclick="toggleSearch()" class="text-white/80 hover:text-white transition p-2"><i class="fas fa-search text-xl"></i></button>
        </div>

        <!-- Buscador -->
        <div id="searchBar" class="hidden absolute top-20 left-0 w-full px-6 z-30 animate-fade-in-down">
            <form onsubmit="event.preventDefault(); searchCity();" class="flex gap-2 justify-center">
                <input type="text" id="searchInput" placeholder="Busca una ciudad..." class="w-full bg-black/40 backdrop-blur-md border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/50 outline-none text-center font-medium">
            </form>
        </div>

        <!-- Panel Favoritos -->
        <div id="favoritesPanel" class="absolute inset-y-0 left-0 w-3/4 bg-black/80 backdrop-blur-xl z-40 transform -translate-x-full transition-transform duration-300 p-6 text-left border-r border-white/10">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-bold tracking-wide">MIS LUGARES</h2>
                <button onclick="toggleFavorites()"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div id="favoritesList" class="space-y-3"></div>
            <button onclick="addToFavorites()" class="mt-6 w-full py-3 rounded-xl border border-white/20 hover:bg-white/10 transition flex items-center justify-center gap-2 text-sm font-bold">
                <i class="fas fa-plus"></i> Guardar ubicación
            </button>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto custom-scroll pb-4 relative z-10 w-full">
            
            <!-- Main Weather -->
            <div class="flex flex-col items-center justify-center mt-4 mb-8 text-center px-4 w-full">
                
                <!-- Ciudad (Movida aquí para protagonismo) -->
                <div class="flex items-center gap-2 text-white/90 mb-2">
                    <i class="fas fa-location-arrow text-xs opacity-70"></i>
                    <h2 id="cityName" class="text-xl font-semibold tracking-wide">Localizando...</h2>
                </div>

                <div id="mainIcon" class="text-8xl mb-2 drop-shadow-2xl filter animate-pulse flex justify-center transform scale-90">
                    <i class="fas fa-spinner fa-spin text-4xl"></i>
                </div>
                <h1 id="currentTemp" class="text-9xl font-extralight tracking-tighter text-center w-full drop-shadow-lg pl-4">--°</h1>
                <p id="weatherDesc" class="text-xl font-medium capitalize opacity-90 mt-0 text-center w-full">Cargando...</p>
                <div class="flex justify-center gap-6 mt-2 text-sm font-medium opacity-80 w-full">
                    <span>Min: <span id="minTemp">--</span>°</span>
                    <span>Max: <span id="maxTemp">--</span>°</span>
                </div>
            </div>

            <!-- Grid de Datos -->
            <div class="grid grid-cols-3 gap-3 px-6 mb-8 w-full">
                <div class="bg-glass rounded-2xl p-3 flex flex-col items-center justify-center border border-white/10 hover:bg-white/10 transition">
                    <i class="fas fa-wind mb-1 opacity-70"></i>
                    <p id="windSpeed" class="font-bold text-lg">--</p>
                    <p class="text-[10px] uppercase opacity-60 font-bold">Viento</p>
                </div>
                <div class="bg-glass rounded-2xl p-3 flex flex-col items-center justify-center border border-white/10 hover:bg-white/10 transition">
                    <i class="fas fa-tint mb-1 opacity-70"></i>
                    <p id="humidity" class="font-bold text-lg">--</p>
                    <p class="text-[10px] uppercase opacity-60 font-bold">Humedad</p>
                </div>
                <!-- LLUVIA -->
                <div class="bg-glass rounded-2xl p-3 flex flex-col items-center justify-center border border-white/10 hover:bg-white/10 transition">
                    <i class="fas fa-umbrella mb-1 opacity-70"></i>
                    <div class="text-center leading-tight">
                        <p id="rainProb" class="font-bold text-lg">--</p>
                        <p id="rainAmt" class="text-[10px] opacity-80">-- mm</p>
                    </div>
                    <p class="text-[10px] uppercase opacity-60 font-bold mt-1">Lluvia</p>
                </div>
            </div>

            <!-- Horas -->
            <div class="px-6 mb-8 w-full">
                <div class="flex justify-between items-end mb-4 px-1">
                    <h3 class="font-semibold opacity-90 tracking-wide">HOY</h3>
                </div>
                <div id="hourlyForecast" class="flex gap-3 overflow-x-auto custom-scroll pb-4 items-center pl-1">
                    <!-- JS -->
                </div>
            </div>

            <!-- Días -->
            <div class="px-6 w-full mb-8">
                <h3 class="font-semibold opacity-90 mb-4 text-left px-1 tracking-wide"><i class="far fa-calendar-alt mr-2"></i>7 DÍAS</h3>
                <div id="dailyForecast" class="bg-glass rounded-3xl p-2 space-y-1 w-full border border-white/5">
                    <!-- JS -->
                </div>
            </div>
            
            <!-- CREDITOS -->
            <div class="px-6 pb-6 text-center opacity-40 hover:opacity-100 transition-opacity duration-300">
                <p class="text-[10px] font-mono uppercase tracking-widest mb-1">Fuente de datos</p>
                <p class="text-xs font-bold mb-3"><a href="https://open-meteo.com/" target="_blank" class="hover:underline hover:text-white transition-colors">Open-Meteo API</a></p>
                <div class="h-px w-12 bg-white/30 mx-auto mb-3"></div>
                <p class="text-[10px]">Desarrollado por <span class="font-bold">Roberto Muñoz</span></p>
            </div>
        </div>

        <!-- MODAL -->
        <div id="detailModal" class="absolute inset-0 z-50 flex items-center justify-center p-4 modal-closed bg-black/60 backdrop-blur-sm">
            <div class="bg-slate-900/90 border border-white/20 text-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative transform transition-all">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-white/50 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <div id="modalContent"></div>
            </div>
        </div>

    </div>

    <script>
        const API_GEO = "https://geocoding-api.open-meteo.com/v1/search";
        const API_WEATHER = "https://api.open-meteo.com/v1/forecast";

        const weatherTypes = {
            0: { icon: 'fa-sun', bg: 'bg-sunny', name: 'Despejado' },
            1: { icon: 'fa-cloud-sun', bg: 'bg-sunny', name: 'Mayormente Claro' },
            2: { icon: 'fa-cloud-sun', bg: 'bg-cloudy', name: 'Parcialmente Nublado' },
            3: { icon: 'fa-cloud', bg: 'bg-cloudy', name: 'Nublado' },
            45: { icon: 'fa-smog', bg: 'bg-cloudy', name: 'Niebla' },
            51: { icon: 'fa-cloud-rain', bg: 'bg-rainy', name: 'Llovizna' },
            61: { icon: 'fa-cloud-showers-heavy', bg: 'bg-rainy', name: 'Lluvia' },
            80: { icon: 'fa-cloud-showers-water', bg: 'bg-rainy', name: 'Chubascos' },
            95: { icon: 'fa-bolt', bg: 'bg-storm', name: 'Tormenta' }
        };

        let globalData = null;
        let currentCityData = null;
        let favorites = JSON.parse(localStorage.getItem('weatherFavs')) || [];

        window.onload = () => {
            loadFavorites();
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => fetchData(pos.coords.latitude, pos.coords.longitude),
                    () => fetchData(40.4165, -3.7026, "Madrid")
                );
            } else {
                fetchData(40.4165, -3.7026, "Madrid");
            }
        };

        async function fetchData(lat, lon, cityNameOverride = null) {
            try {
                let displayName = cityNameOverride || "Ubicación";
                const url = `${API_WEATHER}?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,is_day,weather_code,wind_speed_10m,visibility,precipitation_probability,precipitation&hourly=temperature_2m,weather_code,is_day,precipitation_probability,apparent_temperature,relative_humidity_2m,wind_speed_10m,pressure_msl&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max,precipitation_probability_max&timezone=auto`;
                
                const res = await fetch(url);
                const data = await res.json();
                globalData = data; 
                currentCityData = { name: displayName, lat, lon };
                updateUI(data, displayName);
            } catch (error) { console.error("Error API", error); }
        }

        async function searchCity() {
            const query = document.getElementById('searchInput').value;
            if(!query) return;
            toggleSearch(); 
            try {
                const res = await fetch(`${API_GEO}?name=${query}&count=1&language=es&format=json`);
                const data = await res.json();
                if(data.results) {
                    const { latitude, longitude, name, country } = data.results[0];
                    fetchData(latitude, longitude, `${name}, ${country}`);
                } else { alert("Ciudad no encontrada"); }
            } catch (e) { alert("Error búsqueda"); }
        }

        function updateUI(data, cityName) {
            const current = data.current;
            const daily = data.daily;
            
            document.getElementById('cityName').innerText = cityName;
            document.getElementById('currentTemp').innerText = Math.round(current.temperature_2m) + "°";
            document.getElementById('minTemp').innerText = Math.round(daily.temperature_2m_min[0]);
            document.getElementById('maxTemp').innerText = Math.round(daily.temperature_2m_max[0]);
            document.getElementById('windSpeed').innerText = current.wind_speed_10m + " km/h";
            document.getElementById('humidity').innerText = current.relative_humidity_2m + "%";
            document.getElementById('rainProb').innerText = daily.precipitation_probability_max[0] + "%";
            const rainAmount = current.precipitation || 0; 
            document.getElementById('rainAmt').innerText = rainAmount + " mm";

            const code = current.weather_code;
            const isDay = current.is_day;
            const info = weatherTypes[code] || weatherTypes[0];
            document.getElementById('weatherDesc').innerText = info.name;
            const iconClass = isDay ? info.icon : (code === 0 ? 'fa-moon' : info.icon);
            document.getElementById('mainIcon').innerHTML = `<i class="fas ${iconClass}"></i>`;
            document.body.className = isDay ? info.bg : 'bg-night';
            
            renderEffects(code, isDay);
            renderHourly(data.hourly);
            renderDaily(data.daily);
        }

        function renderHourly(hourly) {
            const container = document.getElementById('hourlyForecast');
            container.innerHTML = '';
            const currentHourIndex = new Date().getHours();
            for(let i = currentHourIndex; i < currentHourIndex + 24; i++) {
                if (!hourly.time[i]) break;
                const temp = Math.round(hourly.temperature_2m[i]);
                const hCode = hourly.weather_code[i];
                const hIcon = (weatherTypes[hCode] || weatherTypes[0]).icon;
                const timeStr = hourly.time[i].split('T')[1]; 
                container.innerHTML += `
                    <div onclick="openHourlyModal(${i})" class="flex flex-col items-center justify-center min-w-[70px] bg-glass p-3 rounded-2xl border border-white/10 snap-center cursor-pointer hover:bg-white/20 transition active:scale-95">
                        <span class="text-xs opacity-70 mb-2 font-bold">${timeStr}</span>
                        <i class="fas ${hIcon} text-xl mb-2 drop-shadow-md"></i>
                        <span class="font-bold text-lg">${temp}°</span>
                    </div>
                `;
            }
        }

        function renderDaily(daily) {
            const container = document.getElementById('dailyForecast');
            container.innerHTML = '';
            for(let i = 0; i < 7; i++) {
                const date = new Date(daily.time[i]);
                const dayName = i === 0 ? 'Hoy' : date.toLocaleDateString('es-ES', { weekday: 'long' });
                const dCode = daily.weather_code[i];
                const dIcon = (weatherTypes[dCode] || weatherTypes[0]).icon;
                const max = Math.round(daily.temperature_2m_max[i]);
                const min = Math.round(daily.temperature_2m_min[i]);
                container.innerHTML += `
                    <div onclick="openDailyModal(${i})" class="flex justify-between items-center p-3 px-4 hover:bg-white/10 rounded-2xl transition cursor-pointer active:scale-95">
                        <span class="w-24 capitalize font-medium text-left">${dayName}</span>
                        <div class="flex-1 flex justify-center">
                            <i class="fas ${dIcon} opacity-90"></i>
                        </div>
                        <div class="w-24 text-right flex justify-end gap-4">
                            <span class="font-bold">${max}°</span>
                            <span class="opacity-50">${min}°</span>
                        </div>
                    </div>
                `;
            }
        }

        function openHourlyModal(index) {
            const h = globalData.hourly;
            const time = h.time[index].split('T')[1];
            const temp = h.temperature_2m[index];
            const feel = h.apparent_temperature[index];
            const rain = h.precipitation_probability[index];
            const hum = h.relative_humidity_2m[index];
            const press = h.pressure_msl[index];
            const wind = h.wind_speed_10m[index];
            const html = `
                <div class="text-center">
                    <h3 class="text-3xl font-bold mb-1">${time}</h3>
                    <p class="text-4xl font-thin mb-6">${temp}°C</p>
                    <div class="grid grid-cols-2 gap-4 text-left bg-white/5 p-4 rounded-2xl">
                        <div><p class="text-xs opacity-50">Sensación</p><p class="font-bold">${feel}°</p></div>
                        <div><p class="text-xs opacity-50">Prob. Lluvia</p><p class="font-bold">${rain}%</p></div>
                        <div><p class="text-xs opacity-50">Humedad</p><p class="font-bold">${hum}%</p></div>
                        <div><p class="text-xs opacity-50">Viento</p><p class="font-bold">${wind} km/h</p></div>
                        <div><p class="text-xs opacity-50">Presión</p><p class="font-bold">${press} hPa</p></div>
                    </div>
                </div>`;
            showModal(html);
        }

        function openDailyModal(index) {
            const d = globalData.daily;
            const date = new Date(d.time[index]).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            const max = d.temperature_2m_max[index];
            const min = d.temperature_2m_min[index];
            const uv = d.uv_index_max[index];
            const rainMax = d.precipitation_probability_max[index];
            const sunrise = d.sunrise[index].split('T')[1];
            const sunset = d.sunset[index].split('T')[1];
            const html = `
                <div class="text-center">
                    <h3 class="text-xl font-bold mb-1 capitalize">${date}</h3>
                    <div class="flex justify-center gap-4 text-3xl my-4">
                        <span class="font-bold">${max}°</span> <span class="opacity-50">${min}°</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-left bg-white/5 p-4 rounded-2xl">
                        <div><p class="text-xs opacity-50">Lluvia Máx</p><p class="font-bold text-blue-300">${rainMax}%</p></div>
                        <div><p class="text-xs opacity-50">Índice UV</p><p class="font-bold text-yellow-300">${uv}</p></div>
                        <div><p class="text-xs opacity-50">Amanecer</p><p class="font-bold">${sunrise}</p></div>
                        <div><p class="text-xs opacity-50">Atardecer</p><p class="font-bold">${sunset}</p></div>
                    </div>
                </div>`;
            showModal(html);
        }

        function showModal(contentHTML) {
            const modal = document.getElementById('detailModal');
            document.getElementById('modalContent').innerHTML = contentHTML;
            modal.classList.remove('modal-closed');
            modal.classList.add('modal-open');
        }
        function closeModal() {
            const modal = document.getElementById('detailModal');
            modal.classList.remove('modal-open');
            modal.classList.add('modal-closed');
        }
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if(e.target === document.getElementById('detailModal')) closeModal();
        });

        function renderEffects(code, isDay) {
            const container = document.getElementById('weatherEffects');
            container.innerHTML = ''; 
            if(!isDay) {
                for(let i=0; i<30; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = Math.random()*100 + '%';
                    star.style.top = Math.random()*60 + '%';
                    star.style.width = Math.random()*2 + 'px';
                    star.style.height = star.style.width;
                    star.style.animationDuration = Math.random()*2 + 1 + 's';
                    container.appendChild(star);
                }
            } else if(code === 0 || code === 1) {
                container.innerHTML = '<div class="sun-glow"></div>';
            }
            if(code >= 51 && code <= 99) {
                for(let i=0; i<50; i++) {
                    const drop = document.createElement('div');
                    drop.className = 'rain';
                    drop.style.left = Math.random() * 100 + 'vw';
                    drop.style.animationDuration = Math.random() * 0.5 + 0.5 + 's';
                    drop.style.opacity = Math.random();
                    container.appendChild(drop);
                }
            }
            if(code >= 2 && code <= 48) {
                const cloud = document.createElement('div');
                cloud.className = 'cloud';
                cloud.innerHTML = '<i class="fas fa-cloud text-white text-9xl filter blur-xl"></i>';
                cloud.style.top = '10%';
                cloud.style.animationDuration = '20s';
                container.appendChild(cloud);
            }
        }

        function toggleFavorites() { document.getElementById('favoritesPanel').classList.toggle('-translate-x-full'); }
        function toggleSearch() { 
            const bar = document.getElementById('searchBar');
            bar.classList.toggle('hidden');
            if(!bar.classList.contains('hidden')) document.getElementById('searchInput').focus();
        }
        function addToFavorites() {
            if(!currentCityData) return;
            if(!favorites.some(f => f.name === currentCityData.name)) {
                favorites.push(currentCityData);
                localStorage.setItem('weatherFavs', JSON.stringify(favorites));
                loadFavorites();
            }
            toggleFavorites();
        }
        function loadFavorites() {
            const list = document.getElementById('favoritesList');
            list.innerHTML = '';
            favorites.forEach((fav, index) => {
                list.innerHTML += `
                    <div onclick="loadFav(${index})" class="bg-white/10 p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-white/20 w-full">
                        <span>${fav.name}</span>
                        <button onclick="event.stopPropagation(); removeFav(${index})" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
        }
        function loadFav(index) {
            const fav = favorites[index];
            fetchData(fav.lat, fav.lon, fav.name);
            toggleFavorites(); 
        }
        function removeFav(index) {
            favorites.splice(index, 1);
            localStorage.setItem('weatherFavs', JSON.stringify(favorites));
            loadFavorites();
        }
    </script>
</body>
</html>