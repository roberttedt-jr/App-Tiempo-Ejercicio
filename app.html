<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atmos.</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Atmos">
    
    <link rel="apple-touch-icon" href="atmos-icon.png">
    <link rel="icon" href="atmos-icon.png" type="image/png">

    <!-- Librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;600;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        glass: 'rgba(255, 255, 255, 0.1)',
                        glassDark: 'rgba(0, 0, 0, 0.6)',
                        accent: '#FDE047'
                    },
                    animation: {
                        'gradient-xy': 'gradient-xy 15s ease infinite',
                        'bounce-x': 'bounceHorizontal 1.5s ease-in-out 2',
                    },
                    keyframes: {
                        'gradient-xy': {
                            '0%, 100%': { 'background-size': '200% 200%', 'background-position': 'left center' },
                            '50%': { 'background-size': '200% 200%', 'background-position': 'right center' }
                        },
                        bounceHorizontal: {
                            '0%, 100%': { transform: 'translateX(0)' },
                            '50%': { transform: 'translateX(-20px)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- ESTILOS GLOBALES --- */
        * {
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        .noselect {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            transition: background-image 0.5s ease-in-out, color 0.5s ease;
            color: white;
            height: 100vh;
            width: 100%;
            margin: 0;
            overflow: hidden; 
            overscroll-behavior-y: none;
            font-family: 'Outfit', sans-serif;
            background-color: #1a1a1a;
            background-size: 400% 400%;
            animation: gradientAnimation 20s ease infinite;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Fondos */
        .bg-sunny { background: linear-gradient(-45deg, #4facfe, #00f2fe, #43e97b); } 
        .bg-cloudy { background: linear-gradient(-45deg, #637786, #9CA7B1, #2C3E50); } 
        .bg-rainy { background: linear-gradient(-45deg, #203A43, #2C5364, #0F2027); } 
        .bg-night { background: linear-gradient(-45deg, #0f2027, #203a43, #2c5364); } 
        .bg-storm { background: linear-gradient(-45deg, #232526, #414345, #2C3E50); } 
        .bg-sunrise { background: linear-gradient(-45deg, #f953c6, #b91d73, #2C3E50); }
        .bg-sunset { background: linear-gradient(-45deg, #654ea3, #eaafc8, #2C3E50); }
        .bg-day { background: linear-gradient(-45deg, #4A90E2, #50C9C3, #96deda); }

        /* Contraste Global (Modo Día) */
        body.high-contrast-mode {
            color: #1e293b !important;
            text-shadow: none !important;
        }
        body.high-contrast-mode .text-shadow, 
        body.high-contrast-mode .text-shadow-lg {
            text-shadow: none !important;
        }
        body.high-contrast-mode .bg-glassDark {
            background-color: rgba(255, 255, 255, 0.6) !important;
            border-color: rgba(255, 255, 255, 0.7) !important;
            color: #000 !important;
            box-shadow: 0 4px 15px -1px rgba(0, 0, 0, 0.1);
        }
        body.high-contrast-mode i { color: #0f172a !important; }
        body.high-contrast-mode .skeleton {
            background: linear-gradient(90deg, rgba(0,0,0,0.05) 25%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.05) 75%) !important;
        }

        /* --- FIX v4.3: FORZAR TEXTO BLANCO EN PANEL LATERAL --- */
        /* Esto sobreescribe el modo día para que el panel oscuro siempre tenga texto claro */
        #sidePanel, #sidePanel * {
            color: white !important;
        }
        /* Excepción para inputs dentro del panel para mantener placeholder visible */
        #sidePanel input::placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }
        #sidePanel i {
            color: white !important;
        }
        #sidePanel .text-white\/50 {
            color: rgba(255,255,255,0.5) !important;
        }
        /* Fin del Fix */

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Text Shadow */
        .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .text-shadow-lg { text-shadow: 0 4px 8px rgba(0,0,0,0.4); }

        /* Modales */
        .modal { transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-open { opacity: 1; pointer-events: auto; transform: scale(1); }
        .modal-closed { opacity: 0; pointer-events: none; transform: scale(0.95); }

        /* Skeleton */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
            color: transparent !important;
        }
        .skeleton * { opacity: 0; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Fade Masks */
        .fade-mask-top {
            mask-image: linear-gradient(to bottom, transparent 0px, black 20px, black calc(100% - 60px), transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0px, black 20px, black calc(100% - 60px), transparent 100%);
        }

        /* Avatar Selection */
        .avatar-option:hover { transform: scale(1.1); border-color: #fff; }
        .avatar-selected { border-color: #fff !important; background-color: rgba(255,255,255,0.3); transform: scale(1.15); box-shadow: 0 0 15px rgba(255,255,255,0.3); }
        
        /* Dropdown custom transition */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, opacity 0.3s ease;
            opacity: 0;
        }
        .collapsible-content.open {
            max-height: 1000px; 
            opacity: 1;
            transition: max-height 0.7s ease-in, opacity 0.5s ease;
        }

        /* Custom Toast */
        .toast-notification {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: auto;
            max-width: 90%;
            justify-content: center;
        }
        .toast-notification.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* NAV BAR */
        .nav-bar {
            background-color: transparent; 
            padding-bottom: env(safe-area-inset-bottom, 20px);
            pointer-events: none;
        }
        .nav-bar > * { pointer-events: auto; }

        /* HEADER */
        #mainHeader { transition: all 0.5s ease-in-out; }
        .header-scrolled {
            background: rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            padding-top: 15px !important; 
            padding-bottom: 25px !important; 
            height: 90px !important; 
        }

        /* PAGINATION DOTS */
        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.4);
            transition: all 0.3s ease;
        }
        .dot.active {
            background-color: #fff;
            transform: scale(1.3);
            width: 8px;
            height: 8px;
            box-shadow: 0 0 8px rgba(255,255,255,0.5);
        }
    </style>
</head>
<body class="bg-night relative noselect">

    <!-- Toast -->
    <div id="customToast" class="toast-notification">
        <i class="fas fa-info-circle text-white"></i>
        <span id="toastMessage">Notificación</span>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div id="mainContainer" class="w-full h-full relative overflow-hidden flex flex-col z-10 text-center">
        
        <!-- HEADER -->
        <div id="mainHeader" class="absolute top-0 left-0 w-full z-30 pt-6 pb-2 px-6 flex justify-between items-center pointer-events-none h-20">
            <div class="text-left transition-transform duration-300 origin-left" id="headerLogoContainer">
                <h1 class="font-extrabold tracking-widest text-xl text-white drop-shadow-lg leading-none">ATMOS.</h1>
            </div>
            <button onclick="triggerHaptic(); openProfileModal()" class="pointer-events-auto transition hover:scale-105 active:scale-95" id="headerAvatarBtn">
                 <div id="headerAvatarDisplay" class="w-9 h-9 rounded-full bg-white/10 backdrop-blur-md border border-white/20 flex items-center justify-center text-base shadow-lg">
                     <i class="fas fa-user text-white drop-shadow-sm"></i>
                 </div>
            </button>
        </div>

        <!-- SIDE PANEL -->
        <div id="sidePanel" class="absolute inset-y-0 right-0 w-full md:w-96 bg-black/80 backdrop-blur-2xl z-50 transform translate-x-full transition-transform duration-300 text-left flex flex-col shadow-2xl border-l border-white/10">
            <div class="p-6 pb-4 border-b border-white/10 flex justify-between items-center mt-10">
                <h2 class="text-xl font-bold tracking-wide text-white">LUGARES</h2>
                <button onclick="triggerHaptic(); toggleSidePanel()"><i class="fas fa-times text-lg text-white/50 hover:text-white"></i></button>
            </div>
            <div class="px-6 py-4 border-b border-white/5">
                 <form onsubmit="event.preventDefault(); searchCity();" class="relative">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-white/50"></i>
                    <input type="text" id="searchInput" placeholder="Buscar ciudad..." class="w-full bg-white/10 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white placeholder-white/30 outline-none focus:border-white/30 transition font-medium">
                </form>
                <div id="suggestionsList" class="hidden mt-2 bg-white/5 rounded-xl overflow-hidden border border-white/5"></div>
            </div>
            <div class="overflow-y-auto flex-1 p-6 space-y-4 hide-scroll">
                <h3 class="text-xs font-bold uppercase opacity-50 tracking-widest mb-2">Guardados</h3>
                <div id="favoritesList" class="space-y-2"></div>
                <button onclick="triggerHaptic(); addToFavorites()" class="mt-4 w-full py-3 rounded-xl border border-dashed border-white/20 hover:bg-white/5 transition flex items-center justify-center gap-2 text-sm opacity-70 hover:opacity-100">
                    <i class="fas fa-map-marker-alt"></i> Guardar Ubicación Actual
                </button>
                <div class="mt-8 pt-8 border-t border-white/10">
                    <button onclick="triggerHaptic(); openProfileModal()" class="text-xs uppercase tracking-widest opacity-60 hover:opacity-100 flex items-center gap-2">
                        <i class="fas fa-user-cog"></i> Ajustes de Perfil
                    </button>
                </div>
            </div>
        </div>

        <!-- CONTENIDO -->
        <div id="swipeArea" class="h-full w-full overflow-y-auto hide-scroll pt-20 pb-32 px-0 fade-mask-top relative z-0">
            <div class="flex flex-col items-center justify-center mb-8 text-center px-4 w-full pt-4">
                <div class="mb-2">
                    <h2 id="cityName" class="text-3xl font-bold tracking-wide uppercase leading-none drop-shadow-md text-shadow-lg">Localizando...</h2>
                    <p id="localTime" class="text-sm font-mono opacity-90 mt-1 tracking-wider drop-shadow-sm text-shadow">--:--</p>
                </div>
                
                <div id="mainIcon" class="text-7xl mb-2 drop-shadow-2xl flex justify-center transform scale-110 mt-4 transition-all duration-500 filter drop-shadow-lg">
                    <i class="fas fa-spinner fa-spin text-4xl"></i>
                </div>
                
                <h1 id="currentTemp" class="text-[130px] font-light tracking-tighter leading-none text-center w-full drop-shadow-2xl text-shadow-lg pl-4 skeleton-target">--°</h1>
                
                <p id="weatherDesc" class="text-2xl font-medium capitalize opacity-100 mt-[-10px] text-center w-full drop-shadow-md text-shadow skeleton-target">Cargando...</p>
                
                <!-- ADVISOR -->
                <div id="aiAdvisor" class="mt-2 mb-2 px-4 py-1 rounded-full bg-white/10 backdrop-blur-sm border border-white/10 inline-block text-xs font-medium text-white/90 opacity-0 transition-opacity duration-1000 max-w-[80%] shadow-lg"></div>

                <div class="flex justify-center gap-8 mt-4 text-base font-bold opacity-100 w-full text-shadow">
                    <span class="flex flex-col items-center"><span class="text-[10px] opacity-80 uppercase">Min</span> <span id="minTemp" class="skeleton-target">--°</span></span>
                    <div class="w-px h-8 bg-white/50 shadow-sm"></div>
                    <span class="flex flex-col items-center"><span class="text-[10px] opacity-80 uppercase">Max</span> <span id="maxTemp" class="skeleton-target">--°</span></span>
                </div>
            </div>

            <div class="px-6 mb-10 w-full h-32">
                 <div class="w-full h-full relative filter drop-shadow-md">
                    <canvas id="tempChart"></canvas>
                 </div>
            </div>

            <h3 class="font-bold opacity-90 tracking-widest text-[10px] uppercase mb-4 px-6 text-left text-shadow">Detalles Actuales</h3>
            
            <!-- GRIT DE DETALLES -->
            <div class="grid grid-cols-3 gap-3 px-6 mb-4 w-full">
                <!-- LOS 3 PRINCIPALES -->
                <div class="bg-glassDark rounded-2xl p-3 flex flex-col items-center justify-center border border-white/10 backdrop-blur-md shadow-lg">
                    <i class="fas fa-wind mb-2 opacity-80 text-lg" id="windDirArrow"></i>
                    <p id="windSpeed" class="font-bold text-base leading-none skeleton-target">--</p>
                    <p class="text-[9px] uppercase opacity-60 font-bold tracking-widest mt-1">Viento</p>
                </div>
                <div class="bg-glassDark rounded-2xl p-3 flex flex-col items-center justify-center border border-white/10 backdrop-blur-md shadow-lg">
                    <i class="fas fa-tint mb-2 opacity-80 text-lg"></i>
                    <p id="humidity" class="font-bold text-base leading-none skeleton-target">--</p>
                    <p class="text-[9px] uppercase opacity-60 font-bold tracking-widest mt-1">Humedad</p>
                </div>
                <div class="bg-glassDark rounded-2xl p-3 flex flex-col items-center justify-center border border-white/10 backdrop-blur-md shadow-lg">
                    <i class="fas fa-cloud-rain mb-2 opacity-80 text-lg"></i>
                    <p id="rainProb" class="font-bold text-base skeleton-target">--</p>
                    <p class="text-[9px] uppercase opacity-60 font-bold tracking-widest mt-1">Prob.</p>
                </div>

                <!-- LOS 6 SECUNDARIOS (Ocultos) -->
                <div class="extra-detail hidden bg-glassDark rounded-2xl p-3 flex flex-col items-center justify-center border border-white/10 backdrop-blur-md shadow-lg">
                    <i class="fas fa-sun mb-2 opacity-80 text-lg"></i>
                    <p id="uvDisplay" class="font-bold text-base skeleton-target">--</p>
                    <p class="text-[9px] uppercase opacity-60 font-bold tracking-widest mt-1">UV</p>
                </div>
                <div class="extra-detail hidden bg-glassDark rounded-2xl p-3 flex flex-col items-center justify-center border border-white/10 backdrop-blur-md shadow-lg">
                    <i id="sunIcon" class="fas fa-mountain-sun mb-2 opacity-80 text-lg"></i>
                    <p id="sunTime" class="font-bold text-base skeleton-target">--</p>
                    <p class="text-[9px] uppercase opacity-60 font-bold tracking-widest mt-1">Sol</p>
                </div>
                <div class="extra-detail hidden bg-glassDark rounded-2xl p-3 flex flex-col items-center justify-center border border-white/10 backdrop-blur-md shadow-lg">
                    <i class="fas fa-lungs mb-2 opacity-80 text-lg" id="aqiIcon"></i>
                    <p id="aqiDisplay" class="font-bold text-base skeleton-target">--</p>
                    <p class="text-[9px] uppercase opacity-60 font-bold tracking-widest mt-1">AQI</p>
                </div>
                <div class="extra-detail hidden bg-glassDark rounded-2xl p-3 flex flex-col items-center justify-center border border-white/10 backdrop-blur-md shadow-lg">
                    <i class="fas fa-compress-arrows-alt mb-2 opacity-80 text-lg"></i>
                    <p id="pressureDisplay" class="font-bold text-base skeleton-target">--</p>
                    <p class="text-[9px] uppercase opacity-60 font-bold tracking-widest mt-1">Presión</p>
                </div>
                <div class="extra-detail hidden bg-glassDark rounded-2xl p-3 flex flex-col items-center justify-center border border-white/10 backdrop-blur-md shadow-lg">
                    <i class="fas fa-droplet mb-2 opacity-80 text-lg"></i>
                    <p id="dewPointDisplay" class="font-bold text-base skeleton-target">--</p>
                    <p class="text-[9px] uppercase opacity-60 font-bold tracking-widest mt-1">Rocío</p>
                </div>
                <div class="extra-detail hidden bg-glassDark rounded-2xl p-3 flex flex-col items-center justify-center border border-white/10 backdrop-blur-md shadow-lg">
                    <i class="fas fa-eye mb-2 opacity-80 text-lg"></i>
                    <p id="visibilityDisplay" class="font-bold text-base skeleton-target">--</p>
                    <p class="text-[9px] uppercase opacity-60 font-bold tracking-widest mt-1">Visib.</p>
                </div>
            </div>
            
            <!-- Botón Ver Más Detalles -->
            <div class="px-6 mb-10">
                <button onclick="triggerHaptic(); toggleDetails()" id="toggleDetailsBtn" class="w-full py-2 rounded-xl text-xs font-bold opacity-70 hover:opacity-100 transition flex items-center justify-center gap-2 bg-white/5 border border-white/5">
                    <span id="detailsBtnText">Ver más detalles</span>
                    <i class="fas fa-chevron-down text-[10px] transition duration-300" id="detailsBtnArrow"></i>
                </button>
            </div>

            <div class="px-6 mb-10 w-full">
                <div id="hourlyForecast" class="flex gap-3 overflow-x-auto hide-scroll pb-2 items-center pl-1"></div>
            </div>

            <div class="px-6 w-full mb-10">
                <h3 class="font-bold opacity-90 mb-4 text-left px-2 tracking-widest text-[10px] uppercase text-shadow">Pronóstico 7 Días</h3>
                <div id="dailyForecast" class="bg-glassDark rounded-2xl p-2 space-y-0 divide-y divide-white/10 w-full border border-white/10 backdrop-blur-md shadow-lg"></div>
                 <div class="mt-4">
                    <button onclick="triggerHaptic(); toggleExtendedForecast()" id="toggleExtendedBtn" class="w-full py-3 rounded-xl text-xs font-bold opacity-80 hover:opacity-100 transition flex items-center justify-center gap-2 bg-black/20 border border-white/5 text-shadow">
                        <span>Ver 14 Días</span>
                        <i class="fas fa-chevron-down text-[10px] transition duration-300" id="extendedArrow"></i>
                    </button>
                    <div id="extendedForecastContainer" class="collapsible-content">
                        <div id="extendedForecast" class="bg-glassDark rounded-2xl p-2 mt-2 space-y-0 divide-y divide-white/10 w-full border border-white/10 backdrop-blur-md"></div>
                    </div>
                 </div>
            </div>

            <div class="px-6 mb-10 w-full">
                <div class="bg-gradient-to-r from-blue-900/60 to-gray-900/60 border border-white/20 rounded-2xl p-4 flex justify-between items-center backdrop-blur-md hover:bg-white/5 transition shadow-lg">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-300 border border-blue-400/30">
                            <i class="fas fa-umbrella text-lg"></i>
                        </div>
                        <div class="text-left">
                            <p class="font-bold text-sm text-shadow">Alerta de Lluvia</p>
                            <p class="text-[10px] opacity-70 uppercase tracking-wider">Notificar Precipitaciones</p>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="rainAlertToggle" class="sr-only peer" onchange="triggerHaptic(); toggleRainAlert()">
                        <div class="w-11 h-6 bg-black/40 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500 border border-white/10"></div>
                    </label>
                </div>
            </div>

            <div class="px-6 pb-4 text-center opacity-60 text-[10px] mb-24">
                <p class="font-bold mb-2 text-shadow">Diseñado y Desarrollado por Roberto</p>
                <div class="flex justify-center gap-4 opacity-80">
                    <a href="https://open-meteo.com/" target="_blank" class="hover:text-white hover:underline">Open-Meteo</a>
                    <span>•</span>
                    <a href="https://windy.com/" target="_blank" class="hover:text-white hover:underline">Windy.com</a>
                </div>
            </div>
        </div>
        
        <!-- NAV BAR FIXED -->
        <div class="absolute bottom-0 left-0 w-full h-20 nav-bar z-40 flex items-center justify-between px-8">
            <button onclick="triggerHaptic(); openMap('rain')" class="w-12 h-12 rounded-full bg-white/10 border border-white/20 flex items-center justify-center text-white hover:text-white hover:bg-white/20 transition active:scale-90 shadow-2xl backdrop-blur-xl">
                <i class="fas fa-map text-lg drop-shadow-md"></i>
            </button>
            
            <!-- PAGINATION DOTS -->
            <div class="h-8 px-4 bg-white/10 border border-white/20 rounded-full flex items-center gap-2 backdrop-blur-xl shadow-2xl">
                <div id="paginationDots" class="flex gap-2 items-center justify-center px-1">
                    <div class="dot active"></div>
                </div>
            </div>
            
            <button onclick="triggerHaptic(); toggleSidePanel()" class="w-12 h-12 rounded-full bg-white/10 border border-white/20 flex items-center justify-center text-white hover:text-white hover:bg-white/20 transition active:scale-90 shadow-2xl backdrop-blur-xl">
                <i class="fas fa-list-ul text-lg drop-shadow-md"></i>
            </button>
        </div>

        <!-- MODALES Y RESTO DEL CÓDIGO -->
        <div id="detailModal" class="absolute inset-0 z-[60] flex items-center justify-center p-6 modal modal-closed bg-black/60 backdrop-blur-xl">
            <div class="bg-gray-900/80 border border-white/10 text-white w-full max-w-sm rounded-3xl p-8 shadow-2xl relative flex flex-col items-center text-center backdrop-blur-2xl">
                <button onclick="triggerHaptic(); closeModal('detailModal')" class="absolute top-5 right-5 w-8 h-8 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition"><i class="fas fa-times text-sm"></i></button>
                <div id="modalContent" class="w-full"></div>
            </div>
        </div>

        <div id="profileModal" class="absolute inset-0 z-[70] flex items-center justify-center p-6 modal modal-closed bg-black/40 backdrop-blur-xl">
            <div class="bg-black/40 border border-white/10 text-white w-full max-w-sm rounded-3xl p-8 shadow-2xl relative flex flex-col text-center backdrop-blur-xl">
                <button onclick="triggerHaptic(); closeModal('profileModal')" class="absolute top-4 right-4 w-8 h-8 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition"><i class="fas fa-times text-sm"></i></button>
                <div id="profileCreateState" class="hidden">
                    <div class="mb-6 flex justify-center">
                        <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center text-white text-2xl shadow-lg border border-white/20">
                            <i class="fas fa-rocket"></i>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Bienvenido a Atmos</h2>
                    <p class="text-sm opacity-50 mb-6">Tu panel climático personal.</p>
                    <input type="text" id="profileNameInput" placeholder="Tu Nombre" maxlength="12" class="bg-white/5 border border-white/10 rounded-xl p-4 text-center text-white placeholder-white/30 outline-none focus:border-white/50 mb-6 w-full font-bold text-lg transition">
                    <p class="text-[10px] font-bold uppercase tracking-widest opacity-40 mb-3">Elige tu Avatar</p>
                    <div class="grid grid-cols-4 gap-3 mb-6" id="avatarGrid"></div>
                    <p class="text-[10px] font-bold uppercase tracking-widest opacity-40 mb-3">Tus Unidades</p>
                    <div class="flex gap-2 mb-8">
                         <button type="button" onclick="selectCreateUnit('metric', this)" class="flex-1 py-3 rounded-xl border border-white/20 bg-white/10 hover:bg-white/20 transition flex flex-col items-center gap-1 unit-select-btn selected-unit">
                             <span class="font-bold text-sm">Métrico</span><span class="text-[9px] opacity-60">°C • km/h</span>
                         </button>
                         <button type="button" onclick="selectCreateUnit('imperial', this)" class="flex-1 py-3 rounded-xl border border-transparent hover:bg-white/10 transition flex flex-col items-center gap-1 unit-select-btn">
                             <span class="font-bold text-sm">Imperial</span><span class="text-[9px] opacity-60">°F • mph</span>
                         </button>
                    </div>
                    <button onclick="triggerHaptic(); saveProfile()" class="bg-white text-black font-bold py-4 rounded-xl hover:scale-105 transition shadow-lg w-full">Comenzar</button>
                </div>
                <div id="profileViewState" class="hidden flex-col items-center justify-center py-4">
                    <div id="viewAvatar" class="w-24 h-24 rounded-full bg-gray-800/50 mb-4 flex items-center justify-center text-4xl shadow-2xl border-2 border-white/20 backdrop-blur-md"></div>
                    <h2 id="viewName" class="text-3xl font-bold mb-1">Usuario</h2>
                    <p class="text-sm opacity-50 mb-8 uppercase tracking-widest">Miembro Atmos</p>
                    <div class="w-full mb-8 bg-white/5 rounded-xl p-4 border border-white/10">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold uppercase tracking-wider opacity-70">Sistema</span>
                            <div class="flex items-center gap-2 bg-black/30 rounded-lg p-1 border border-white/5">
                                <button id="unitMetricBtn" onclick="triggerHaptic(); toggleUnits('metric')" class="px-3 py-1 rounded text-[10px] font-bold transition bg-white text-black">Métrico</button>
                                <button id="unitImperialBtn" onclick="triggerHaptic(); toggleUnits('imperial')" class="px-3 py-1 rounded text-[10px] font-bold transition opacity-50 hover:opacity-100">Imperial</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 w-full">
                         <button onclick="triggerHaptic(); enableEditMode()" class="flex-1 py-3 bg-white/10 rounded-xl text-sm font-bold hover:bg-white/20 transition"><i class="fas fa-pen mr-2"></i> Editar</button>
                         <button onclick="triggerHaptic(); closeModal('profileModal')" class="flex-1 py-3 border border-white/10 rounded-xl text-sm font-bold hover:bg-white/5 transition">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="mapModal" class="absolute inset-0 z-[80] flex flex-col bg-black transition-transform duration-500 transform translate-y-full">
            <div class="flex justify-between items-center p-4 bg-black/90 backdrop-blur-xl z-10 border-b border-white/10 pt-10">
                <h2 id="mapTitle" class="font-bold text-sm tracking-wide flex items-center gap-2 uppercase"><i class="fas fa-radar text-yellow-400"></i> Mapa</h2>
                <button onclick="triggerHaptic(); closeMap()" class="bg-white/10 px-4 py-2 rounded-full text-xs font-bold hover:bg-white/20 transition border border-white/10">Hecho</button>
            </div>
            <div class="flex-1 relative w-full bg-gray-900">
                 <iframe id="windyFrame" width="100%" height="100%" src="" frameborder="0" class="absolute inset-0"></iframe>
                 <div class="absolute inset-0 flex items-center justify-center pointer-events-none" id="mapLoader"><i class="fas fa-spinner fa-spin text-4xl text-white/50"></i></div>
            </div>
            <div class="absolute bottom-24 left-1/2 transform -translate-x-1/2 flex gap-4 z-20 bg-black/80 backdrop-blur-md p-2 rounded-full border border-white/10 shadow-2xl">
                 <button onclick="triggerHaptic(); openMap('rain')" class="w-12 h-12 rounded-full hover:bg-white/20 text-blue-300 flex flex-col items-center justify-center gap-1 transition active:scale-90"><i class="fas fa-cloud-showers-heavy text-lg"></i><span class="text-[8px] uppercase font-bold">Lluvia</span></button>
                 <button onclick="triggerHaptic(); openMap('wind')" class="w-12 h-12 rounded-full hover:bg-white/20 text-cyan-300 flex flex-col items-center justify-center gap-1 transition active:scale-90"><i class="fas fa-wind text-lg"></i><span class="text-[8px] uppercase font-bold">Viento</span></button>
                 <button onclick="triggerHaptic(); openMap('temp')" class="w-12 h-12 rounded-full hover:bg-white/20 text-orange-300 flex flex-col items-center justify-center gap-1 transition active:scale-90"><i class="fas fa-thermometer-half text-lg"></i><span class="text-[8px] uppercase font-bold">Temp</span></button>
            </div>
        </div>

    </div>

    <script>
        // CONFIG & STATE
        const API_GEO = "https://geocoding-api.open-meteo.com/v1/search";
        const API_WEATHER = "https://api.open-meteo.com/v1/forecast";
        const API_AIR = "https://air-quality-api.open-meteo.com/v1/air-quality";
        
        let globalData = null;
        let currentCityData = null;
        let favorites = JSON.parse(localStorage.getItem('weatherFavs')) || [];
        let userProfile = JSON.parse(localStorage.getItem('atmosProfile')) || null;
        let currentUnits = localStorage.getItem('atmosUnits') || 'metric';
        let tempUnitSelection = 'metric';
        let searchTimeout;
        let tempChartInstance = null;
        let selectedAvatarIcon = 'fa-user-astronaut';
        let currentViewIndex = 0; 
        let homeLocation = { lat: 40.4165, lon: -3.7026, name: "Madrid" }; 

        // Arrays e iconos
        const avatars = [
            { icon: 'fa-user-astronaut', color: 'bg-purple-500' }, { icon: 'fa-sun', color: 'bg-yellow-500' }, { icon: 'fa-bolt', color: 'bg-blue-500' },
            { icon: 'fa-snowflake', color: 'bg-cyan-400' }, { icon: 'fa-cloud-moon', color: 'bg-indigo-500' }, { icon: 'fa-poo-storm', color: 'bg-amber-700' },
            { icon: 'fa-cat', color: 'bg-orange-400' }, { icon: 'fa-robot', color: 'bg-gray-500' }
        ];
        const weatherTypes = {
            0: { icon: 'fa-sun', name: 'Despejado' }, 1: { icon: 'fa-cloud-sun', name: 'Mayormente Claro' }, 2: { icon: 'fa-cloud-sun', name: 'Parcialmente Nublado' },
            3: { icon: 'fa-cloud', name: 'Nublado' }, 45: { icon: 'fa-smog', name: 'Niebla' }, 51: { icon: 'fa-cloud-rain', name: 'Llovizna' },
            61: { icon: 'fa-cloud-showers-heavy', name: 'Lluvia' }, 80: { icon: 'fa-cloud-showers-water', name: 'Chubascos' }, 95: { icon: 'fa-bolt', name: 'Tormenta' }
        };

        function setText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }
        function showToast(message) { const t = document.getElementById('customToast'); if(t) { document.getElementById('toastMessage').innerText = message; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }}
        function toggleSkeleton(show) { document.querySelectorAll('.skeleton-target').forEach(el => el.classList.toggle('skeleton', show)); }
        function triggerHaptic() { if(navigator.vibrate) navigator.vibrate(15); }
        
        // Toggle Detalles
        function toggleDetails() {
            const hiddenItems = document.querySelectorAll('.extra-detail');
            const btnText = document.getElementById('detailsBtnText');
            const btnArrow = document.getElementById('detailsBtnArrow');
            let isExpanding = false;

            hiddenItems.forEach(item => {
                if(item.classList.contains('hidden')) { item.classList.remove('hidden'); isExpanding = true; } 
                else { item.classList.add('hidden'); isExpanding = false; }
            });

            if(isExpanding) { btnText.innerText = "Ver menos detalles"; btnArrow.classList.add('rotate-180'); } 
            else { btnText.innerText = "Ver más detalles"; btnArrow.classList.remove('rotate-180'); }
        }

        function triggerBounceAnimation() { const c=document.getElementById('mainContainer'); if(c){ c.classList.remove('animate-bounce-x'); void c.offsetWidth; c.classList.add('animate-bounce-x'); setTimeout(()=>c.classList.remove('animate-bounce-x'),3000); }}
        function cToF(c) { return (c * 9/5) + 32; }
        function fToC(f) { return (f - 32) * 5/9; }
        function kmToMph(k) { return k / 1.60934; }
        function formatTemp(val) { if(val===undefined||val===null)return '--'; return (currentUnits==='imperial'?Math.round(cToF(val)):Math.round(val))+"°"; }
        function formatSpeed(val) { if(val===undefined||val===null)return '--'; return (currentUnits==='imperial'?Math.round(kmToMph(val))+" mph":val+" km/h"); }
        
        function toggleUnits(mode) { currentUnits = mode; localStorage.setItem('atmosUnits', mode); updateUnitButtons(); if(globalData && currentCityData) updateUI(globalData, currentCityData.name); }
        function selectCreateUnit(mode, btn) { tempUnitSelection = mode; triggerHaptic(); document.querySelectorAll('.unit-select-btn').forEach(b => { b.classList.remove('border-white/20','bg-white/10'); b.classList.add('border-transparent'); }); btn.classList.remove('border-transparent'); btn.classList.add('border-white/20','bg-white/10'); }
        
        function updateUnitButtons() {
            const m = document.getElementById('unitMetricBtn'), i = document.getElementById('unitImperialBtn');
            if(m && i) {
                if(currentUnits === 'metric') { m.className = "px-3 py-1 rounded text-[10px] font-bold transition bg-white text-black"; i.className = "px-3 py-1 rounded text-[10px] font-bold transition opacity-50 hover:opacity-100"; }
                else { i.className = "px-3 py-1 rounded text-[10px] font-bold transition bg-white text-black"; m.className = "px-3 py-1 rounded text-[10px] font-bold transition opacity-50 hover:opacity-100"; }
            }
        }

        window.onload = () => {
            checkOnboarding();
            loadFavorites();
            loadProfileUI();
            generateAvatarGrid();
            toggleSkeleton(true);
            setupSwipe();
            
            const scrollArea = document.getElementById('swipeArea');
            const header = document.getElementById('mainHeader');
            if(scrollArea && header) {
                scrollArea.addEventListener('scroll', () => {
                    if (scrollArea.scrollTop > 50) header.classList.add('header-scrolled');
                    else header.classList.remove('header-scrolled');
                });
            }
            updateUnitButtons();
            
            if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((pos) => { homeLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude, name: "Ubicación Actual" }; loadView(0); }, () => loadView(0)); } else loadView(0);
            
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const q = e.target.value.trim();
                clearTimeout(searchTimeout);
                if(q.length<3) { document.getElementById('suggestionsList').classList.add('hidden'); return; }
                searchTimeout = setTimeout(() => fetchSuggestions(q), 300);
            });
            document.getElementById('rainAlertToggle').checked = localStorage.getItem('rainAlertActive') === 'true';
        };

        function loadView(index) { currentViewIndex = index; let t = (index===0)?homeLocation:favorites[index-1]; fetchData(t.lat, t.lon, t.name); updatePaginationDots(); }
        function updatePaginationDots() {
            const c = document.getElementById('paginationDots'); if(!c)return; c.innerHTML = '';
            for(let i=0; i<1+favorites.length; i++) { const d=document.createElement('div'); d.className=`dot ${i===currentViewIndex?'active':''}`; c.appendChild(d); }
        }
        function setupSwipe() {
            const sa = document.getElementById('swipeArea'); if(!sa)return; let sx=0, ex=0;
            sa.addEventListener('touchstart', e => sx = e.changedTouches[0].screenX);
            sa.addEventListener('touchend', e => { ex = e.changedTouches[0].screenX; if (ex < sx - 50 && currentViewIndex < favorites.length) loadView(currentViewIndex + 1); else if (ex > sx + 50 && currentViewIndex > 0) loadView(currentViewIndex - 1); });
        }

        function checkOnboarding() { if (!localStorage.getItem('atmos_launched')) openProfileModal(); }
        function openProfileModal() {
            const m=document.getElementById('profileModal'), c=document.getElementById('profileCreateState'), v=document.getElementById('profileViewState');
            if(!m||!c||!v)return;
            if (userProfile && localStorage.getItem('atmos_launched')) {
                c.classList.add('hidden'); c.classList.remove('block'); v.classList.remove('hidden'); v.classList.add('flex');
                const av = avatars.find(a => a.icon === userProfile.avatar) || avatars[0];
                document.getElementById('viewAvatar').innerHTML = `<i class="fas ${av.icon} text-white"></i>`;
                document.getElementById('viewAvatar').className = `w-24 h-24 rounded-full mb-4 flex items-center justify-center text-4xl shadow-2xl border-4 border-white/20 ${av.color} backdrop-blur-md`;
                setText('viewName', userProfile.name); updateUnitButtons();
            } else {
                v.classList.add('hidden'); v.classList.remove('flex'); c.classList.remove('hidden'); c.classList.add('block');
                if(userProfile) document.getElementById('profileNameInput').value = userProfile.name;
            }
            m.classList.remove('modal-closed'); m.classList.add('modal-open'); toggleSidePanel(true);
        }
        function enableEditMode() { document.getElementById('profileViewState').classList.add('hidden'); document.getElementById('profileViewState').classList.remove('flex'); document.getElementById('profileCreateState').classList.remove('hidden'); document.getElementById('profileCreateState').classList.add('block'); }
        function loadProfileUI() {
            if(userProfile) {
                const av = avatars.find(a => a.icon === userProfile.avatar) || avatars[0];
                const hd = document.getElementById('headerAvatarDisplay');
                if(hd) { hd.className = `w-10 h-10 rounded-full flex items-center justify-center text-lg shadow-lg border border-white/30 ${av.color}`; hd.innerHTML = `<i class="fas ${av.icon} text-white drop-shadow-sm"></i>`; }
            }
        }
        function generateAvatarGrid() {
            const g = document.getElementById('avatarGrid'); if(!g)return; g.innerHTML='';
            avatars.forEach(av => { const b=document.createElement('button'); b.className=`avatar-option w-12 h-12 rounded-full flex items-center justify-center text-white transition border-2 border-transparent ${av.color}`; b.innerHTML=`<i class="fas ${av.icon}"></i>`; b.onclick=()=>{triggerHaptic();selectAvatar(av.icon,b)}; g.appendChild(b); });
        }
        function selectAvatar(i, b) { selectedAvatarIcon = i; document.querySelectorAll('.avatar-option').forEach(x=>x.classList.remove('avatar-selected')); b.classList.add('avatar-selected'); }
        function saveProfile() {
            const n = document.getElementById('profileNameInput').value.trim(); if(!n)return;
            currentUnits = tempUnitSelection; localStorage.setItem('atmosUnits', currentUnits);
            userProfile = { name: n, avatar: selectedAvatarIcon }; localStorage.setItem('atmosProfile', JSON.stringify(userProfile)); localStorage.setItem('atmos_launched', 'true');
            loadProfileUI(); updateUnitButtons(); if(globalData) updateUI(globalData, currentCityData.name);
            closeModal('profileModal'); setTimeout(triggerBounceAnimation, 500);
        }

        function toggleSidePanel(close=false) { const p=document.getElementById('sidePanel'); if(p) { if(close)p.classList.remove('translate-x-0'); else p.classList.toggle('translate-x-0'); }}
        async function fetchSuggestions(q) { try { const r=await fetch(`${API_GEO}?name=${q}&count=5&language=es&format=json`); const d=await r.json(); const l=document.getElementById('suggestionsList'); l.innerHTML=''; if(d.results){ d.results.forEach(c=>{ const x=document.createElement('div'); x.className="p-3 hover:bg-white/10 cursor-pointer flex justify-between items-center border-b border-white/5 last:border-0 transition text-sm"; x.innerHTML=`<div><span class="font-bold block">${c.name}</span><span class="text-[10px] opacity-50 block uppercase">${c.country}</span></div>`; x.onclick=()=>{triggerHaptic();selectSuggestion(c)}; l.appendChild(x); }); l.classList.remove('hidden'); } else l.classList.add('hidden'); } catch(e){console.error(e);} }
        function selectSuggestion(c) { homeLocation={lat:c.latitude,lon:c.longitude,name:c.name}; document.getElementById('searchInput').value=''; document.getElementById('suggestionsList').classList.add('hidden'); toggleSidePanel(true); loadView(0); }
        async function searchCity() { const q=document.getElementById('searchInput').value; if(q) fetchSuggestions(q).then(()=>{const f=document.querySelector('#suggestionsList > div');if(f)f.click()}); }

        function addToFavorites() { if(!currentCityData)return; if(!favorites.some(f=>f.name===currentCityData.name)){ favorites.push(currentCityData); localStorage.setItem('weatherFavs', JSON.stringify(favorites)); loadFavorites(); updatePaginationDots(); } showToast("Ubicación guardada"); }
        function loadFavorites() { const l=document.getElementById('favoritesList'); if(!l)return; l.innerHTML=''; if(favorites.length===0){l.innerHTML='<p class="text-xs opacity-30 text-center py-2">Sin favoritos</p>';return;} favorites.forEach((f,i)=>{ l.innerHTML+=`<div onclick="triggerHaptic();loadView(${i+1});toggleSidePanel(true);" class="bg-white/5 p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-white/10 w-full border border-white/5 transition"><span class="font-bold text-sm">${f.name}</span><button onclick="event.stopPropagation();triggerHaptic();removeFav(${i})" class="text-white/30 hover:text-red-400"><i class="fas fa-trash"></i></button></div>`; }); }
        function removeFav(i) { favorites.splice(i,1); localStorage.setItem('weatherFavs',JSON.stringify(favorites)); loadFavorites(); updatePaginationDots(); if(currentViewIndex===i+1)loadView(0); else if(currentViewIndex>i+1)currentViewIndex--; }

        function openMap(t) {
            const m=document.getElementById('mapModal'), f=document.getElementById('windyFrame'), l=document.getElementById('mapLoader'); if(!m)return;
            l.style.display='flex'; const lat=currentCityData?currentCityData.lat:40.4165, lon=currentCityData?currentCityData.lon:-3.7026;
            const ut=currentUnits==='imperial'?'%C2%B0F':'%C2%B0C', uw=currentUnits==='imperial'?'mph':'km%2Fh';
            f.src=`https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&detailLat=${lat}&detailLon=${lon}&width=650&height=450&zoom=5&level=surface&overlay=${t}&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=${uw}&metricTemp=${ut}&radarRange=-1`;
            f.onload=()=>{l.style.display='none'}; m.classList.remove('translate-y-full');
        }
        function closeMap(){ const m=document.getElementById('mapModal'); if(m)m.classList.add('translate-y-full'); }

        async function fetchData(lat,lon,name) {
            toggleSkeleton(true); try {
                const wURL = `${API_WEATHER}?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,is_day,weather_code,wind_speed_10m,wind_direction_10m,visibility,precipitation_probability,precipitation,pressure_msl,dew_point_2m&hourly=temperature_2m,weather_code,is_day,precipitation_probability,apparent_temperature,relative_humidity_2m,wind_speed_10m,pressure_msl&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max,precipitation_probability_max,precipitation_sum&forecast_days=14&timezone=auto`;
                const aURL = `${API_AIR}?latitude=${lat}&longitude=${lon}&current=european_aqi`;
                const [wR, aR] = await Promise.all([fetch(wURL), fetch(aURL)]);
                const wD = await wR.json(), aD = await aR.json();
                globalData={...wD, aqi:aD.current?aD.current.european_aqi:null}; currentCityData={name:name||"Ubicación", lat, lon}; updateUI(globalData, currentCityData.name);
            } catch(e){ console.error(e); toggleSkeleton(false); }
        }

        function updateUI(d, name) {
            toggleSkeleton(false); const c=d.current, dy=d.daily; setText('cityName', name);
            const ts=c.time.split('T')[1].split(':'); setText('localTime', `${ts[0]}:${ts[1]}`);
            
            const now=new Date(c.time).getTime(), rise=new Date(dy.sunrise[0]).getTime(), set=new Date(dy.sunset[0]).getTime(), m=45*60000;
            let bg='bg-night', day=false;
            if(now>=rise-m && now<=rise+m) { bg='bg-sunrise'; day=true; }
            else if(now>=set-m && now<=set+m) { bg='bg-sunset'; day=true; }
            else if(now>rise+m && now<set-m) { day=true; const x=c.weather_code; if(x>=95||(x>=61&&x<=65))bg='bg-storm'; else if(x>=61)bg='bg-rainy'; else if(x>=3)bg='bg-cloudy'; else bg='bg-day'; }
            document.body.className = `${bg} relative noselect`; 
            if(['bg-day','bg-sunny','bg-cloudy'].includes(bg)) document.body.classList.add('high-contrast-mode'); else document.body.classList.remove('high-contrast-mode');

            setText('currentTemp', formatTemp(c.temperature_2m)); setText('minTemp', formatTemp(dy.temperature_2m_min[0])); setText('maxTemp', formatTemp(dy.temperature_2m_max[0]));
            setText('windSpeed', formatSpeed(c.wind_speed_10m));
            const wa=document.getElementById('windDirArrow'); if(wa) wa.style.transform=`rotate(${c.wind_direction_10m}deg)`;
            setText('humidity', c.relative_humidity_2m+"%"); setText('rainProb', dy.precipitation_probability_max[0]+"%"); setText('uvDisplay', Math.round(dy.uv_index_max[0]));
            
            let vis=c.visibility, vT=""; if(currentUnits==='imperial') vT=(vis/1609.34).toFixed(1)+" mi"; else vT=(vis/1000).toFixed(1)+" km";
            setText('pressureDisplay', Math.round(c.pressure_msl)+" hPa"); setText('dewPointDisplay', formatTemp(c.dew_point_2m)); setText('visibilityDisplay', vT);

            const aqi=d.aqi; setText('aqiDisplay', aqi!==null?aqi:"--");
            const aqI=document.getElementById('aqiIcon'); if(aqI){ aqI.className="fas fa-lungs mb-2 opacity-80 text-lg"; if(aqi!==null){ if(aqi<20)aqI.classList.add('text-green-300'); else if(aqi<50)aqI.classList.add('text-yellow-300'); else aqI.classList.add('text-red-300'); }}

            let st="--:--", sl="Sol"; 
            if(now<rise){st=new Date(rise).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});sl="Amanecer";}
            else if(now<set){st=new Date(set).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});sl="Atardecer";}
            else {st=new Date(dy.sunrise[1]).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});sl="Amanecer";}
            setText('sunTime', st); setText('sunLabel', sl);

            const info=weatherTypes[c.weather_code]||weatherTypes[0]; setText('weatherDesc', info.name);
            const ic=day?info.icon:(c.weather_code===0?'fa-moon':info.icon);
            document.getElementById('mainIcon').innerHTML=`<i class="fas ${ic} text-white drop-shadow-md"></i>`;

            updateAIAdvisor(c.weather_code, c.temperature_2m, dy.precipitation_probability_max[0]);
            renderChart(d.hourly); renderHourly(d.hourly); renderDaily(d.daily);
        }

        function updateAIAdvisor(code, t, rain) {
            const a=document.getElementById('aiAdvisor'); if(!a)return;
            let m=""; if(code>=95)m="Tormenta inminente. Busca refugio."; else if(rain>70)m="Lleva paraguas, va a llover."; else if(t>30)m="Usa protector solar e hidrátate."; else if(t<5)m="Abrígate bien, hace frío."; else if(t<15)m="Lleva una chaqueta ligera."; else if(code===0)m="Día perfecto para salir."; else m="Condiciones estables.";
            if(userProfile&&userProfile.name) m=`${m}`;
            a.innerText=m; a.classList.remove('opacity-0');
        }

        function renderChart(h) {
            const cv=document.getElementById('tempChart'); if(!cv)return; const ctx=cv.getContext('2d');
            if(tempChartInstance)tempChartInstance.destroy();
            const cur=new Date().getHours(), lbs=[], dts=[];
            for(let i=cur; i<cur+24; i+=3){ if(!h.time[i])break; lbs.push(h.time[i].split('T')[1].substring(0,5)); let v=h.temperature_2m[i]; if(currentUnits==='imperial')v=cToF(v); dts.push(Math.round(v)); }
            const gr=ctx.createLinearGradient(0,0,0,400); gr.addColorStop(0,'rgba(255,255,255,0.5)'); gr.addColorStop(1,'rgba(255,255,255,0)');
            tempChartInstance = new Chart(ctx, {
                type:'line', data:{ labels:lbs, datasets:[{ label:'Temp', data:dts, borderColor:'#fff', backgroundColor:gr, borderWidth:3, pointBackgroundColor:'#fff', pointRadius:3, fill:true, tension:0.4 }] },
                options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{enabled:true, backgroundColor:'rgba(0,0,0,0.8)', titleFont:{family:'Outfit'}, bodyFont:{family:'Outfit',weight:'bold'}, padding:10, displayColors:false, callbacks:{label:c=>c.parsed.y+(currentUnits==='imperial'?'°F':'°C')}}}, scales:{x:{display:true,grid:{display:false},ticks:{color:'rgba(255,255,255,0.8)',font:{size:9,weight:'bold'}}},y:{display:false}}}
            });
        }

        function renderHourly(h) {
            const c=document.getElementById('hourlyForecast'); if(!c)return; c.innerHTML=''; const cur=new Date().getHours();
            for(let i=cur; i<cur+24; i++){ if(!h.time[i])break; const t=formatTemp(h.temperature_2m[i]), ic=(weatherTypes[h.weather_code[i]]||weatherTypes[0]).icon, ts=h.time[i].split('T')[1].substring(0,5); c.innerHTML+=`<div onclick="triggerHaptic();openHourlyModal(${i})" class="flex flex-col items-center justify-center min-w-[60px] snap-center cursor-pointer opacity-90 hover:opacity-100 transition text-shadow"><span class="text-[10px] opacity-80 mb-2 font-bold">${ts}</span><i class="fas ${ic} text-lg mb-2 drop-shadow-sm"></i><span class="font-bold text-sm">${t}</span></div>`; }
        }
        function renderDaily(d) {
            const c7=document.getElementById('dailyForecast'), c14=document.getElementById('extendedForecast'); if(!c7)return; c7.innerHTML=''; if(c14)c14.innerHTML='';
            for(let i=0; i<7; i++){
                const dt=new Date(d.time[i]), ic=(weatherTypes[d.weather_code[i]]||weatherTypes[0]).icon, max=formatTemp(d.temperature_2m_max[i]), min=formatTemp(d.temperature_2m_min[i]);
                let dn=(i===0)?'Hoy':(i===1?'Mañana':dt.toLocaleDateString('es-ES',{weekday:'short'}));
                c7.innerHTML+=`<div onclick="triggerHaptic();openDailyModal(${i})" class="grid grid-cols-[2fr,1fr,1fr] items-center p-3 hover:bg-white/10 transition cursor-pointer border-b border-white/5 last:border-0"><div class="flex items-center gap-3"><span class="uppercase font-bold text-xs opacity-90 w-12 text-shadow">${dn}</span><i class="fas ${ic} text-sm opacity-90 drop-shadow-sm"></i></div><div class="flex justify-end gap-4 text-sm text-shadow"><span class="font-bold">${max}</span><span class="opacity-60 font-bold">${min}</span></div></div>`;
            }
            if(d.time.length>=14 && c14) {
                for(let i=7; i<14; i++){
                    const dt=new Date(d.time[i]), ic=(weatherTypes[d.weather_code[i]]||weatherTypes[0]).icon, max=formatTemp(d.temperature_2m_max[i]), min=formatTemp(d.temperature_2m_min[i]), dn=dt.toLocaleDateString('es-ES',{month:'numeric',day:'numeric'});
                    c14.innerHTML+=`<div onclick="triggerHaptic();openDailyModal(${i})" class="grid grid-cols-[2fr,1fr,1fr] items-center p-2 hover:bg-white/5 transition cursor-pointer text-xs"><div class="flex items-center gap-3"><span class="opacity-60 w-8">${dn}</span><i class="fas ${ic} opacity-50"></i></div><div class="flex justify-end gap-4"><span class="font-bold">${max}</span><span class="opacity-40">${min}</span></div></div>`;
                }
            }
        }

        function openHourlyModal(i) { const h=globalData.hourly, t=h.time[i].split('T')[1], tmp=formatTemp(h.temperature_2m[i]), sp=formatSpeed(h.wind_speed_10m[i]); showModal('detailModal', `<h3 class="text-4xl font-bold mb-2">${t}</h3><p class="text-6xl font-light mb-4">${tmp}</p><div class="grid grid-cols-2 gap-4 text-left text-sm bg-white/10 p-4 rounded-xl"><div><span class="opacity-50">Viento</span> <br><b>${sp}</b></div><div><span class="opacity-50">Lluvia</span> <br><b>${h.precipitation_probability[i]}%</b></div></div>`); }
        function openDailyModal(i) { const d=globalData.daily, dt=new Date(d.time[i]).toLocaleDateString('es-ES',{weekday:'long',day:'numeric'}), max=formatTemp(d.temperature_2m_max[i]), min=formatTemp(d.temperature_2m_min[i]); showModal('detailModal', `<h3 class="text-xl font-bold mb-4 capitalize">${dt}</h3><div class="flex justify-center gap-6 text-4xl mb-6"><span class="font-bold">${max}</span><span class="opacity-50">${min}</span></div><div class="grid grid-cols-2 gap-4 text-left text-sm bg-white/10 p-4 rounded-xl"><div><span class="opacity-50">UV Max</span> <br><b>${d.uv_index_max[i]}</b></div><div><span class="opacity-50">Lluvia</span> <br><b>${d.precipitation_probability_max[i]}%</b></div></div>`); }

        function showModal(id,c) { if(c)document.getElementById('modalContent').innerHTML=c; document.getElementById(id).classList.remove('modal-closed'); document.getElementById(id).classList.add('modal-open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('modal-open'); document.getElementById(id).classList.add('modal-closed'); }
        function toggleExtendedForecast() { const c=document.getElementById('extendedForecastContainer'), a=document.getElementById('extendedArrow'); if(c&&a){c.classList.toggle('open'); a.classList.toggle('rotate-180');} }
    </script>
</body>
</html>
